<?php
/**
 * @file
 * Code for the core_ef feature.
 */

include_once 'core_ef.features.inc';

function core_ef_init() {
  if (isset($_GET['pop']) && $_GET['pop'] == 1) {
    drupal_set_message('**Testing the pop up messages. Ipsum lorem. E plurbis unum. E tu Brute. Ipsum lorem. E plurbis unum. E tu Brute. Ipsum lorem. E plurbis unum. E tu Brute. Ipsum lorem. E plurbis unum. E tu Brute. Ipsum lorem. E plurbis unum. E tu Brute.');
  }
}


function core_ef_form_alter(&$form, &$form_state, $form_id) {
  //dpm("form_id: " . $form_id);
  //dpm($form);
}


function core_ef_form_user_profile_form_alter(&$form, &$form_state) {
  $form['contact']['#access'] = FALSE;
  $form['timezone']['#access'] = FALSE;
  $form['field_client_type']['#disabled'] = TRUE;
  // setup redirect to Company Appliation if cookie exists for client/get-started
  if (isset($_COOKIE['destination']) && $_COOKIE['destination'] == 'client/get-started') {
    setcookie("destination", "", time() - 3600, "/");
    $_GET['destination'] = 'client/get-started';
  }
}

function core_ef_form_data_person_node_form_alter(&$form, &$form_state) {
  //dpm($form);
  //dpm($form_state);

  $form['field_product_id']['#type'] = 'hidden';
  $form['field_kba']['#access'] = FALSE;
  $form['additional_settings']['#access'] = FALSE;
  $form['field_company']['#disabled'] = TRUE;
  $form['field_name_first']['#disabled'] = TRUE;
  $form['field_name_last']['#disabled'] = TRUE;
  $form['field_name_middle']['#disabled'] = TRUE;
  $form['field_name_maiden']['#disabled'] = TRUE;
  $form['field_name_suffix']['#disabled'] = TRUE;
  $form['field_ssn']['#disabled'] = TRUE;
  $form['field_dob']['#disabled'] = TRUE;
  $form['field_gender']['#disabled'] = TRUE;
  $form['field_email_address']['#disabled'] = TRUE;
   // Change button labels for Residence
  _core_ef_set_button($form['field_address']['und'], "Add an Address", "Remove this Address", TRUE);
  // Change button labels for Employment
  _core_ef_set_button($form['field_employment']['und'], "Add an Employer", "Remove this Employer", TRUE);
  // Change button labels for Education
  _core_ef_set_button($form['field_education']['und'], "Add a Degree", "Remove this Degree", TRUE);
  // Change button labels for Criminal
  _core_ef_set_button($form['field_criminal']['und'], "Add a Conviction", "Remove this Conviction", TRUE);

  return $form;
}

function core_ef_form_data_company_node_form_alter(&$form, &$form_state) {
  //dpm($form);
  //dpm($form_state);
  if ($form['field_invite_officers']['und'][0]['field_first_name']['und'][0]['value']['#default_value'] == NULL
    && $form['field_invite_officers']['und'][0]['field_last_name']['und'][0]['value']['#default_value'] == NULL
    && $form['field_invite_officers']['und'][0]['field_email']['und'][0]['email']['#default_value'] == NULL) {
    global $user;
    $account = user_load($user->uid);
    $form['field_invite_officers']['und'][0]['field_first_name']['und'][0]['value']['#default_value'] = $account->field_name_first['und'][0]['value'];
    $form['field_invite_officers']['und'][0]['field_last_name']['und'][0]['value']['#default_value'] = $account->field_name_last['und'][0]['value'];
    $form['field_invite_officers']['und'][0]['field_email']['und'][0]['email']['#default_value'] = $account->mail;
  }

  //$form['field_product_id']['#type'] = 'hidden';
  $form['additional_settings']['#access'] = FALSE;
  $form['field_purchase_completed']['#access'] = FALSE;
  // Change button labels for DBA
  _core_ef_set_button($form['field_dba']['und'],"Add a DBA", "Remove this DBA", TRUE);
  // Change button labels for Officers
  _core_ef_set_button($form['field_invite_officers']['und'], "Add an Officer", "Remove this Officer", TRUE);

  // check KBA completion settings
  if ($form['nid']['#value']) {
    dpm($form['nid']['#value']);
    if (!_em_apply_verify_complete($form['nid']['#value'])) {
      $form['field_agree_final']['#disabled'] = TRUE;
    }
  }
  return $form;
}

function _core_ef_set_button(&$field, $label_add, $label_remove, $remove_button = FALSE) {
  $field['add_more']['#value'] = $label_add;
  foreach ($field as $key => &$button_field) {
    if (is_numeric($key)) {
      if ($key == 0 && $remove_button == TRUE) {
        unset($button_field['remove_button']);
      } else {
        $button_field['remove_button']['#value'] = $label_remove;
      }
    }
  }
  return $field;
}

function core_ef_date_combo_process_alter(&$element, $form_state, $context) {
  if ($element['#field_name'] == 'field_address_dates') {
    // set label on checkbox for End Date to "Previous Address?"
    $element['value']['#title'] = t('From Date:');
    $element['value2']['#title'] = t('To Date:');
    $element['show_todate']['#title'] = t('Previous Address?');
  }
  if ($element['#field_name'] == 'field_employment_dates') {
    // set label on checkbox for End Date to "Previous Employment?"
    $element['value']['#title'] = t('From Date:');
    $element['value2']['#title'] = t('To Date:');
    $element['show_todate']['#title'] = t('Previous Employment?');
  }
}

