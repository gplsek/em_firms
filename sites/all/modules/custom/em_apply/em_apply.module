<?php

function em_apply_menu() {
  $items = array();

  $items['client/get-started'] = array(
    'page callback' => 'em_apply_check',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['user/%/apply'] = array(
    'page callback' => 'em_apply_form',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}
/**
 * Implementation of hook_block_info().
 */
function em_apply_block_info() {
  $blocks['apply-block'] = array(
    'info' => t('Custom: Apply Block'),
  );

  return $blocks;
}

function em_apply_block_view($delta='') {
    $block = array();
    switch ($delta) {
	  case 'apply-block':
            $block['subject'] = '';
           // $block['content'] = apply_block();
           $block['content'] = "<a href='client/get-started'>GET STARTED</a>";
        break;
    }
    return $block;
}

function em_apply_check(){
	global $user;

	if($user->uid == '0'){
		drupal_goto('user/login/',array('query'=>array('destination' => 'client/get-started')));
	}else{
		drupal_goto('user/'.$user->uid.'/apply');
	}
	return;


}

function em_apply_form($uid){
  global $user;
  $node = (object) array('uid' => $user->uid, 'name' => (isset($user->name) ? $user->name : ''), 'type' => 'data_company', 'language' => LANGUAGE_NONE);
  $form_state['build_info']['args'] = array($node);
  form_load_include($form_state, 'inc', 'node', 'node.pages');
	return drupal_get_form('data_company_node_form');
}





function em_apply_node_presave($node) {
	if ($node->type == 'data_company'){
		unset($node->field_fein);
	}

}

function em_apply_node_update($node) {
	if ($node->type == 'data_company'){
		unset($node->field_fein);
	}

}

function em_apply_node_prepare($node) {
  if ($node->type == 'data_company'){
	 $node->field_fein['und'][0]['value'] = 'test fein';
	}

}

/*
function em_apply_form_alter(&$form, &$form_state, $form_id) {
  dpm($form_id);
}
*/

function em_apply_form_data_company_node_form_alter(&$form, &$form_state) {
  //dpm($form);
  //dpm($form_state);
  $form['field_constituents']['und']['add_more']['#value'] = "Add another Officer";
  $form['field_constituents']['und'][0]['remove_button']['#value'] = "Remove this Officer";


  global $user;
  //dpm($user);
  $owner = $form_state['node']->uid;
  //also see if the user exists in the company table
  // only allow Admin users to view/edit some fields while disabled or hidden for Auth only users
  if ($owner <> $user->uid || (in_array('authenticated user', $user->roles) && !in_array('administrator', $user->roles))){



    //doesn't work
    //$form['field_company_address']['#collapsible'] = TRUE;
    //$form['field_company_address']['#attributes']['class'][] = ' collapsed';

    $form['group_company']['#disabled'] = TRUE;
    $form['field_company_phone']['#disabled'] = TRUE;
    $form['field_company_address']['#access'] = FALSE;

    /*$form['field_company_address']['#attached']['library'][] = array('system', 'drupal.collapse');
    $form['field_company_address']['#attributes']['class'][] = 'collapsible';
    if (!empty($form['field_company_address']['#collapsed'])) {
      $form['field_company_address']['#attributes']['class'][] = 'collapsed';
    }*/


	  return $form;
	}
}

function em_apply_user($op, &$edit, &$account, $category = NULL) {
  global $user;

  if ($op == 'login') {
    // Load the anonymous user
    drupal_goto(referer_uri());
  }
}
